<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<i>results are shown in the browser console</i>
</body>
<script  type='module' src="./pako_original.js"></script>
<script type="module">

import { Pako_Deflate , zlib_deflate,zlib_messages,zlib_constants,zlib_ZStream}  from './pako/Pako_full.js';
import {HTTPrequestResult,tester} from './pako/_testTools.js';




const short_sample = 'hello world';
let request = new HTTPrequestResult();

const long_sample = (await HTTPrequestResult.makeRequest('GET', 'pako/fixtures/samples/lorem_en_100k.txt')).data;

function testDeflate(data, opts, flush) {
  const deflator = new Pako_Deflate(opts);
  deflator.push(data, flush);
  deflator.push(data, true);
  tester.assert(deflator.err ==0 , zlib_messages.msg(deflator.err));
}




tester.run('Deflate support', () => {
    tester.run('stored', () => {
    testDeflate(short_sample, { level: 0, chunkSize: 200 }, 0);
    testDeflate(short_sample, { level: 0, chunkSize: 10 }, 5);
  });
    tester.run('fast', () => {
    testDeflate(short_sample, { level: 1, chunkSize: 10 }, 5);
    testDeflate(long_sample, { level: 1, memLevel: 1, chunkSize: 10 }, 0);
  });
    tester.run('slow', () => {
    testDeflate(short_sample, { level: 4, chunkSize: 10 }, 5);
    testDeflate(long_sample, { level: 9, memLevel: 1, chunkSize: 10 }, 0);
  });
    tester.run('rle', () => {
    testDeflate(short_sample, { strategy: 3 }, 0);
    testDeflate(short_sample, { strategy: 3, chunkSize: 10 }, 5);
    testDeflate(long_sample, { strategy: 3, chunkSize: 10 }, 0);
  });
    tester.run('huffman', () => {
    testDeflate(short_sample, { strategy: 2 }, 0);
    testDeflate(short_sample, { strategy: 2, chunkSize: 10 }, 5);
    testDeflate(long_sample, { strategy: 2, chunkSize: 10 }, 0);

  });
});

tester.run('Deflate states', () => {
  //in port checking input parameters was removed
    tester.run('inflate bad parameters', () => {
    let ret, strm;

    ret = zlib_deflate.deflate(null, 0);
    tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test A failed");

    strm = new zlib_ZStream();

    ret = zlib_deflate.deflateInit(null);
        tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test B failed");

    ret = zlib_deflate.deflateInit(strm, 6);
        tester.assert(ret === zlib_constants.Z_OK,"test C failed");

    ret = zlib_deflate.deflateSetHeader(null);
        tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test D failed");

    strm.state.wrap = 1;
    ret = zlib_deflate.deflateSetHeader(strm, null);
        tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test E failed");

    strm.state.wrap = 2;
    ret = zlib_deflate.deflateSetHeader(strm, null);
        tester.assert(ret === zlib_constants.Z_OK,"test F failed");

    ret = zlib_deflate.deflate(strm, zlib_constants.Z_FINISH);
        tester.assert(ret === zlib_constants.Z_BUF_ERROR,"test G failed");

    ret = zlib_deflate.deflateEnd(null);
        tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test H failed");

    //BS_NEED_MORE
    strm.state.status = 5;
    ret = zlib_deflate.deflateEnd(strm);
        tester.assert(ret === zlib_constants.Z_STREAM_ERROR,"test I failed");
  });
});
console.log("Done.")
</script>

</html>

